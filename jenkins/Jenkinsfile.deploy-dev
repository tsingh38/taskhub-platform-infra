pipeline {
  agent any
  options { disableConcurrentBuilds() }

  parameters {
    string(
      name: 'IMAGE_TAG',
      defaultValue: 'KEEP_CURRENT',
      description: 'Docker image tag to deploy to DEV. Use KEEP_CURRENT to apply Helm values without changing the image.'
    )
  }

  environment {
    KUBECONFIG = "/var/lib/jenkins/.kube/config"

    // DEV target
    NAMESPACE  = "dev"
    RELEASE    = "task-service"
    IMAGE_REPO = "tsingh38/taskhub"

    // chart lives in infra repo
    CHART_DIR  = "infra/helm/charts/task-service"
    VALUES_DEV = "infra/helm/values/task-service/values-dev.yaml"
  }

  stages {

    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Validate') {
      steps {
        script {
          // Webhook-triggered builds often pass IMAGE_TAG as empty -> treat as KEEP_CURRENT
          if (!params.IMAGE_TAG?.trim()) {
            env.EFFECTIVE_TAG = "KEEP_CURRENT"
          } else {
            env.EFFECTIVE_TAG = params.IMAGE_TAG.trim()
          }
          echo "Deploy DEV: namespace=${env.NAMESPACE}, release=${env.RELEASE}, IMAGE_TAG=${env.EFFECTIVE_TAG}"
        }

        sh '''
          set -eu
          test -f "$KUBECONFIG"
          test -d "$CHART_DIR"
          test -f "$VALUES_DEV"
        '''
      }
    }

    stage('Helm Upgrade DEV (task-service only)') {
      steps {
        dir("${env.CHART_DIR}") {
          script {
            def cmd = """
              set -eu
              export KUBECONFIG="${env.KUBECONFIG}"

              helm upgrade --install "${env.RELEASE}" . \\
                -n "${env.NAMESPACE}" --create-namespace \\
                -f "${env.WORKSPACE}/${env.VALUES_DEV}" \\
                --wait --timeout 7m --atomic
            """.stripIndent()

            if (env.EFFECTIVE_TAG != "KEEP_CURRENT") {
              cmd += """
                --set image.repository="${env.IMAGE_REPO}" \\
                --set image.tag="${env.EFFECTIVE_TAG}"
              """.stripIndent()
            } else {
              cmd += "\n# KEEP_CURRENT: not overriding image.tag\n"
            }

            sh cmd
          }
        }
      }
    }

    stage('Post-Deploy Checks') {
      steps {
        sh '''
          set -eu
          export KUBECONFIG="$KUBECONFIG"

          echo "DEV Pods:"
          kubectl -n dev get pods -o wide || true
          echo ""
          echo "DEV Service:"
          kubectl -n dev get svc task-service -o wide || true
          echo ""
          echo "DEV Helm Release:"
          helm -n dev status task-service | sed -n '1,60p' || true
        '''
      }
    }
  }

  post {
    success { echo "DEV Deploy Success (IMAGE_TAG=${env.EFFECTIVE_TAG})" }
    failure { echo "DEV Deploy Failed (IMAGE_TAG=${env.EFFECTIVE_TAG})" }
  }
}