pipeline {
  agent any

  options {
    disableConcurrentBuilds()
    skipDefaultCheckout(true)
  }

  parameters {
    string(name: 'IMAGE_TAG', defaultValue: '', description: 'Docker image tag to deploy to DEV (required)')
  }

  environment {
    KUBECONFIG = "/var/lib/jenkins/.kube/config"

    NAMESPACE  = "dev"
    RELEASE    = "task-service"
    IMAGE_REPO = "tsingh38/taskhub"

    CHART_DIR  = "infra/helm/charts/task-service"
    VALUES_DEV = "infra/helm/values/task-service/values-dev.yaml"
  }

  stages {

    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Validate') {
      steps {
        script {
          if (!params.IMAGE_TAG?.trim()) error("IMAGE_TAG is required (example: 0.1.1-SNAPSHOT-12)")
          env.IMAGE_TAG = params.IMAGE_TAG.trim()
          echo "Deploy DEV with IMAGE_TAG=${env.IMAGE_TAG}"
        }

        sh '''
          set -eu
          test -f "$KUBECONFIG"
          test -d "$CHART_DIR"
          test -f "$WORKSPACE/$VALUES_DEV"
        '''
      }
    }

    stage('Helm Upgrade DEV (task-service only)') {
      steps {
        dir("${env.CHART_DIR}") {
          sh '''
            set -eu
            export KUBECONFIG="$KUBECONFIG"

            helm upgrade --install "$RELEASE" . \
              -n "$NAMESPACE" --create-namespace \
              -f "$WORKSPACE/$VALUES_DEV" \
              --set image.repository="$IMAGE_REPO" \
              --set image.tag="$IMAGE_TAG" \
              --wait --timeout 7m --atomic
          '''
        }
      }
    }

    stage('Post-Deploy Checks') {
      steps {
        sh '''
          set -eu
          export KUBECONFIG="$KUBECONFIG"
          kubectl -n dev get pods -o wide || true
          kubectl -n dev get svc task-service -o wide || true
          helm -n dev status task-service | sed -n '1,80p' || true
        '''
      }
    }
  }

  post {
    success { echo "DEV Deploy Success (IMAGE_TAG=${params.IMAGE_TAG})" }
    failure { echo "DEV Deploy Failed (IMAGE_TAG=${params.IMAGE_TAG})" }
  }
}