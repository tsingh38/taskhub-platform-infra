pipeline {
  agent any

  options {
    disableConcurrentBuilds()
  }

  parameters {
    string(
      name: 'IMAGE_TAG',
      defaultValue: '',
      description: 'Docker image tag to deploy to DEV (e.g., 0.1.0-SNAPSHOT-58). Required.'
    )
  }

  environment {
    KUBECONFIG = "/var/lib/jenkins/.kube/config"

    // DEV target
    NAMESPACE = "dev"
    RELEASE   = "task-service"

    // Task-service chart + values (UPDATE these paths to your infra repo layout)
    TASK_CHART_DIR  = "infra/helm/charts/task-service"
    TASK_VALUES_DEV = "infra/helm/charts/task-service/values-dev.yaml"

    // Image repo
    IMAGE_REPO = "tsingh38/taskhub"
  }

  stages {

    stage('Validate') {
      steps {
        script {
          if (!params.IMAGE_TAG?.trim()) {
            error("IMAGE_TAG is required (example: 0.1.0-SNAPSHOT-58).")
          }
          echo "Deploying DEV: ns=${env.NAMESPACE}, release=${env.RELEASE}, image=${env.IMAGE_REPO}:${params.IMAGE_TAG}"
        }

        sh '''
          set -eu
          export KUBECONFIG="$KUBECONFIG"
          test -f "$KUBECONFIG"
        '''
      }
    }

    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Helm Upgrade task-service (DEV)') {
      steps {
        dir("${env.TASK_CHART_DIR}") {
          sh '''
            set -eu
            export KUBECONFIG="$KUBECONFIG"

            test -f "${WORKSPACE}/${TASK_VALUES_DEV}"

            helm upgrade --install "${RELEASE}" . \
              -n "${NAMESPACE}" --create-namespace \
              -f "${WORKSPACE}/${TASK_VALUES_DEV}" \
              --set image.repository="${IMAGE_REPO}" \
              --set image.tag="${IMAGE_TAG}" \
              --wait --timeout 5m --atomic
          '''
        }
      }
    }

    stage('Post-deploy checks') {
      steps {
        sh '''
          set -eu
          export KUBECONFIG="$KUBECONFIG"

          echo "DEV Pods:"
          kubectl -n dev get pods -o wide || true
          echo ""
          echo "DEV Service:"
          kubectl -n dev get svc task-service -o wide || true
          echo ""
          echo "DEV Helm Release:"
          helm -n dev status task-service | sed -n '1,60p' || true
        '''
      }
    }
  }

  post {
    success { echo "DEV Deploy Success (IMAGE_TAG=${params.IMAGE_TAG})" }
    failure { echo "DEV Deploy Failed" }
  }
}